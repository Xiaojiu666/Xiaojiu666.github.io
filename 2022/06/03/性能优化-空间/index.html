<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Gx">



    <meta name="description" content="description">



<title>性能优化-空间 | Nine`s Blog</title>



    <link rel="icon" href="/image/luancher.jpg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.0.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Nine&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">博客</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Nine&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">博客</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">性能优化-空间</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Gx</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">June 3, 2022&nbsp;&nbsp;14:05:41</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="包体积"><a href="#包体积" class="headerlink" title="包体积"></a>包体积</h3><p>瘦身优化 最主要的好处是对应用 下载转化率 的影响，同样竞品，包体积越小，用户下载等待的时间也会越短，所以下载转换成功率也就越高。所以，安装包大小与下载转化率的关系 大致是成反比 的，即安装包越大，下载转换率就越小。现在很多大型的 App 一般都会有一个 Lite 版本的 App，这个也是出于下载转化率方面的考虑。</p>
<h6 id="Apk组成"><a href="#Apk组成" class="headerlink" title="Apk组成"></a>Apk组成</h6><p>Android 项目最终会编译成一个 .apk 后缀的文件，实际上它就是一个 压缩包。因此，它内部还有很多不同类型的文件，这些文件，按照大小，共分为如下四类：</p>
<ul>
<li><p>1、代码相关：<br>classes.dex，我们在项目中所编写的 java 文件，经过编译之后会生成一个 .class 文件，而这些所有的 .class 文件呢，它最终会经过 dx 工具编译生成一个 classes.dex。</p>
</li>
<li><p>2、资源相关：<br>res、assets、编译后的二进制资源文件 resources.arsc 和 清单文件 等等。res 和 assets 的不同在于 res 目录下的文件会在 .R 文件中生成对应的资源 ID，而 assets 不会自动生成对应的 ID，而是通过 AssetManager 类的接口来获取。此外，每当在 res 文件夹下放一个文件时，aapt 就会自动生成对应的 id 并保存在 .R 文件中，但 .R 文件仅仅只是保证编译程序不会报错，实际上在应用运行时，系统会根据 ID 寻找对应的资源路径，而 resources.arsc 文件就是用来记录这些 ID 和 资源文件位置对应关系 的文件。</p>
</li>
<li><p>3、JNI So 相关：<br>lib 目录下的文件，这块文件的优化空间其实非常大。</p>
</li>
<li><p>4、META-INF：<br>它存放了应用的签名信息，不是我们的优化方向，不做具体介绍。</p>
</li>
</ul>
<p>根据apk内的文件组成，我们可以得出我们的三大优化方向：代码(classes.dex)、资源(Assets、res、resources.arsc)、so库。</p>
<h6 id="优化方案"><a href="#优化方案" class="headerlink" title="优化方案"></a>优化方案</h6><h6 id="代码相关"><a href="#代码相关" class="headerlink" title="代码相关"></a>代码相关</h6><ul>
<li>1、ProGuard : 是一个免费的 Java 类文件 压缩、优化、混淆、预先校验 的工具。<br>不仅可以通过ProGuard进行类混淆，简化类名，还可以检测并移除未使用到的类、方法、字段以及指令、冗余代码(网上很多教程，不细说)，值得注意的是，混淆过后的代码，可以通过<a target="_blank" rel="noopener" href="https://juejin.cn/post/6863089679969812488">mapping.txt</a>找到映射</li>
<li>2、Lint : ProGuard只是在编译期帮我们删除那些无用代码，在项目里面这些代码还是存在的。但是我们要更好地维护项目的话，一些无用的代码始终还是需要删除的。Lint工具就能够帮我们找到那些无用的代码，包括无用的类、方法和类属性。工具栏Code -&gt; Inspect Code<br><img src="https://upload-images.jianshu.io/upload_images/5442795-dd61c59a47f672a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br><img src="https://upload-images.jianshu.io/upload_images/5442795-15bf90f48fb4b9b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></li>
<li>3、第三方依赖处理<ul>
<li>减少库的下载</li>
<li>在同样的需求实现前提下，调研多个库，使用体积较小的库</li>
<li>很多库的代码结构都设计的比较好，如果我们引入三方库的时候，可以只引入部分需要的代码，而不是将整个包的代码都引入进来。</li>
</ul>
</li>
</ul>
<h6 id="资源相关"><a href="#资源相关" class="headerlink" title="资源相关"></a>资源相关</h6><ul>
<li>Lint 的 Remove Unused Resource</li>
<li>图片资源 使用谷歌推荐的.webp图片转换，转换后一张图片大小约减少百分之90<br><img src="https://upload-images.jianshu.io/upload_images/5442795-ebfebeaee3cc629d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1669702132862.jpg"></li>
<li>shrinkResources : 使用使用build.gradle中的 shrinkResources true 来开启资源压缩<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            shrinkResources <span class="literal">true</span></span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles</span><br><span class="line">                <span class="title function_">getDefaultProguardFile</span><span class="params">(<span class="string">&#x27;proguard-android.txt&#x27;</span>)</span>,</span><br><span class="line">                <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>resConfigs : 资源缩减器只会移除未由应用代码引用的资源，这意味着，它不会移除用于不同设备配置的备用资源。 使用使用build.gradle中的 resConfigs  来移除<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        //打包时 只保留英文和日文</span><br><span class="line">        resConfigs &quot;en&quot;, &quot;ja&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>资源在线化: 将一些资源文件，做成主题包，首次启动时下载</li>
</ul>
<h6 id="JNI-x2F-SO库相关"><a href="#JNI-x2F-SO库相关" class="headerlink" title="JNI&#x2F;SO库相关"></a>JNI&#x2F;SO库相关</h6><ul>
<li>不同CPU对应的架构指令不同， 目前，Android 一共 支持7种不同类型的 CPU 架构，比如常见的 armeabi、armeabi-v7a、X86 等等。理论上来说，对应架构的 CPU 它的执行效率是最高的，但是这样会导致 在 lib 目录下会多存放了各个平台架构的 So 文件，所以 App 的体积自然也就更大了。<br>因此，我们就需要对 lib 目录进行缩减，我们 在 build.gradle 中配置这个 abiFiliters 去设置 App 支持的 So 架构，其配置代码如下所示：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">defaultConfig &#123;</span><br><span class="line">    ndk &#123;</span><br><span class="line">        <span class="comment">//// 指定要ndk需要兼容的架构(这样其他依赖包里mips,x86,armeabi,arm-v8之类的so会被过滤掉)</span></span><br><span class="line">        abiFilters <span class="string">&quot;armeabi&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="文件缓存大小"><a href="#文件缓存大小" class="headerlink" title="文件缓存大小"></a>文件缓存大小</h6><ul>
<li>减少项目中无用日志写出，减少存储空间 缓存</li>
<li>定期清理无用缓存</li>
</ul>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><h6 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h6><p>即应该被GC回收的内存，由于还在被其他对象引用，导致无法被回收。内存泄漏是比较严重的问题，过多的内存泄漏会导致内存溢出，产生OOM的系统错误。</p>
<ul>
<li>单例类引用Context造成内存泄漏。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">单例类应引用Application的Context，因为Application的Context的生命周期是和APP一致的，不会造成单例类引用某个activity的context以致该activity无法被回收的问题。</span><br></pre></td></tr></table></figure></li>
<li>非静态内部类引用外部类造成内存泄漏。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将非静态内部类改为静态内部类，这样就不会引用外部类。</span><br></pre></td></tr></table></figure></li>
<li>handler引用activity造成内存泄漏。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">handler：a.handler使用结束时调用removeCallbacksAndMessages(null)清除队列；</span><br><span class="line">static class SafeHandler extends Handler &#123;</span><br><span class="line">     WeakReference&lt;MainActivity&gt; activity;</span><br><span class="line">     public SafeHandler(MainActivity mainActivity) &#123;</span><br><span class="line">             activity = new WeakReference&lt;MainActivity&gt;(mainActivity);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override public void handleMessage(Message msg) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line">b.静态内部类+弱引用方式可避免内存泄漏。</span><br></pre></td></tr></table></figure></li>
<li>属性动画没有取消，导致view一直被引用造成内存泄漏。</li>
<li>监听器没有取消、回调没有反注册。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">属性动画、监听器使用结束应及时取消，广播或其他一些外部库的回调应该及时反注册。</span><br></pre></td></tr></table></figure>
<h6 id="内存溢出"><a href="#内存溢出" class="headerlink" title="内存溢出"></a>内存溢出</h6></li>
<li>加载的图片或者资源过大，导致内存空间大小不够</li>
</ul>
<h6 id="内存优化"><a href="#内存优化" class="headerlink" title="内存优化"></a>内存优化</h6><ul>
<li>使用线程池，因为线程本身会占用相对比较大的内存，通过线程池合理分配线程，避免过度占用资源。</li>
<li>自定义View时，在onDraw方法内避免创建对象。因为onDraw会被频繁调用，导致其内部的对象也会被频繁创建，占用过多内存。</li>
<li>尽量使用StringBuilder或StringBuffer拼接字符串，减少String的使用。（因为拼接字符串时，String会创建新的对象，而StringBuilder、StringBuffer是在原字符串基础上拼接）</li>
<li>视图资源不可见时进行清除，避免占用内存。如Bitmap执行.recycle方法进行清除、对图片和lottie资源进行销毁。</li>
<li>针对内存泄漏的问题进行优化：</li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Gx</span>
                    </p>
                
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"># 性能优化</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2022/06/07/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E6%97%B6%E9%97%B4/">性能优化-时间</a>
            
            
            <a class="next" rel="next" href="/2022/05/01/RecyclerView_%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6Recycler/">RecyclerView_缓存机制Recycler</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Gx | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>